<!--/////////////////////////////////////////////////-->
<!--//PAGE FOR THE EXTENSIONS BACKEND IN LNBITS//////-->
<!--/////////////////////////////////////////////////-->

{% extends "base.html" %} {% from "macros.jinja" import window_vars with context
%} {% block scripts %} {{ window_vars(user) }}
<script src="https://unpkg.com/nostr-tools/lib/nostr.bundle.js"></script>
<script src="{{ static_url_for('nostriotdashboard/static', path='js/index.js') }}"></script>
{% endblock %} {% block page %}

<div id="vue">
  <q-layout view="hHh lpR fFf">
    <q-page-container>
      <q-page class="q-pa-md">
        
        <!-- Header -->
        <div class="row q-mb-lg">
          <div class="col">
            <h4 class="q-mt-none q-mb-md">Nostr IoT Dashboard</h4>
            <p class="text-caption">Interact with Nostr IoT devices using DVM protocol</p>
          </div>
        </div>

        <!-- Authentication Section -->
        <q-card v-if="!isAuthenticated" class="q-mb-lg">
          <q-card-section>
            <h6 class="q-mt-none">Connect with Nostr</h6>
            <p class="text-caption">Connect your Nostr browser extension to access IoT devices</p>
            <q-btn 
              color="primary" 
              label="Connect Nostr Extension" 
              @click="connectNostr"
              :loading="connecting"
            />
          </q-card-section>
        </q-card>

        <!-- Relay Configuration -->
        <q-card v-if="isAuthenticated" class="q-mb-lg">
          <q-card-section>
            <div class="row items-center q-mb-md">
              <h6 class="q-mt-none q-mb-none col">Relay Configuration</h6>
              <q-btn 
                size="sm" 
                color="primary" 
                icon="add" 
                @click="addRelay" 
                round 
                dense
              />
            </div>
            <div class="row q-gutter-sm">
              <q-chip 
                v-for="relay in relays" 
                :key="relay"
                :label="relay"
                removable
                @remove="removeRelay(relay)"
                color="primary"
                text-color="white"
              />
            </div>
          </q-card-section>
        </q-card>

        <!-- IoT Devices -->
        <div v-if="isAuthenticated">
          <div class="row items-center q-mb-md">
            <h6 class="q-mt-none q-mb-none col">IoT Devices</h6>
            <q-btn 
              size="sm" 
              color="positive" 
              icon="refresh" 
              @click="refreshDevices"
              :loading="loadingDevices"
              round 
              dense
            />
          </div>

          <!-- Loading State -->
          <div v-if="loadingDevices" class="text-center q-pa-lg">
            <q-spinner size="xl" color="primary" />
            <p class="q-mt-md">Discovering IoT devices...</p>
          </div>

          <!-- No Devices Found -->
          <q-card v-else-if="iotDevices.length === 0" class="text-center q-pa-lg">
            <q-card-section>
              <q-icon name="device_hub" size="xl" color="grey-5" />
              <h6 class="q-mt-md q-mb-sm">No IoT devices found</h6>
              <p class="text-caption">Follow some Nostr accounts that provide IoT services</p>
            </q-card-section>
          </q-card>

          <!-- Device List -->
          <div v-else class="row q-gutter-md">
            <q-card 
              v-for="device in iotDevices" 
              :key="device.pubkey"
              class="col-12 col-md-6"
            >
              <q-card-section>
                <div class="text-h6">${device.name}</div>
                <p class="text-caption q-mb-md">${device.about}</p>
                
                <div class="q-gutter-xs">
                  <q-btn
                    v-for="capability in device.capabilities"
                    :key="capability"
                    :label="capability"
                    size="sm"
                    color="primary"
                    outline
                    @click="executeCapability(device, capability)"
                    :loading="isCapabilityLoading(device.pubkey, capability)"
                  >
                    <span v-if="getCapabilityResult(device.pubkey, capability)" class="q-ml-sm">
                      âœ“
                    </span>
                  </q-btn>
                </div>
              </q-card-section>
            </q-card>
          </div>
        </div>

        <!-- Invoice Modal -->
        <q-dialog v-model="invoiceDialog.show">
          <q-card style="min-width: 350px">
            <q-card-section>
              <div class="text-h6">Payment Required</div>
              <p class="text-caption">Amount: ${invoiceDialog.amount} sats</p>
            </q-card-section>
            <q-card-section class="text-center">
              <lnbits-qrcode
                :value="'lightning:' + invoiceDialog.bolt11"
                :href="'lightning:' + invoiceDialog.bolt11"
                :max-width="300"
                class="rounded-borders"
              ></lnbits-qrcode>
              <p class="text-caption q-mt-md">Scan QR code to pay</p>
            </q-card-section>
            <q-card-actions align="right">
              <q-btn flat label="Close" @click="invoiceDialog.show = false" />
            </q-card-actions>
          </q-card>
        </q-dialog>

        <!-- Add Relay Modal -->
        <q-dialog v-model="relayDialog.show">
          <q-card style="min-width: 300px">
            <q-card-section>
              <div class="text-h6">Add Relay</div>
            </q-card-section>
            <q-card-section>
              <q-input 
                v-model="relayDialog.url" 
                label="Relay URL"
                placeholder="wss://relay.example.com"
              />
            </q-card-section>
            <q-card-actions align="right">
              <q-btn flat label="Cancel" @click="relayDialog.show = false" />
              <q-btn color="primary" label="Add" @click="confirmAddRelay" />
            </q-card-actions>
          </q-card>
        </q-dialog>

      </q-page>
    </q-page-container>
  </q-layout>
</div>

{% endblock %}
